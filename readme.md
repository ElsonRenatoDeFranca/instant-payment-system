# Getting Started

## Prerequisites

- JDK 21 (or compatible)
- Maven 3.8.0+
- Docker ([Install](https://docs.docker.com/engine/install/ubuntu/ "Install") | [Configure](https://docs.docker.com/v17.09/engine/installation/linux/linux-postinstall/ "Configure"))
- docker-compose ([Install](https://docs.docker.com/compose/install/ "Install"))

## Project Overview

This is a Spring Boot application implementing the Insurance Capitalization Title API with **multi-versioning support** (v1 and v2). Both API versions coexist independently with their own specifications, DTOs, and business logic while sharing common domain entities and use cases.

### Multi-Versioning Architecture

The project is structured to support multiple major versions of the API:

```
src/main/java/br/com/bradescoseguros/opin/
├── v1/                                    # API Version 1
│   ├── interfaceadapter/
│   │   ├── controller/                   # V1 Controllers
│   │   ├── autogenerated/               # V1 Auto-generated classes from OpenAPI
│   │   ├── mapper/                      # V1 DTOs to Domain mappers
│   │   └── gateway/                     # V1 Gateway implementations
│   └── ...
├── v2/                                    # API Version 2
│   ├── interfaceadapter/
│   │   ├── controller/                   # V2 Controllers (with enhanced features)
│   │   ├── autogenerated/               # V2 Auto-generated classes from OpenAPI
│   │   ├── mapper/                      # V2 DTOs to Domain mappers
│   │   └── gateway/                     # V2 Gateway implementations
│   └── ...
├── businessrule/                         # Shared business logic (both versions)
│   ├── usecase/
│   ├── gateway/
│   ├── validator/
│   └── ...
├── domain/                               # Shared domain entities (both versions)
├── external/                             # External configurations
└── interfaceadapter/                     # Shared adapters
```

### Architecture Layers

![Alt text](docs/clean_architecture.png?raw=true "Clean Architecture Cone")

![Alt text](docs/packages_clean_architecture.png?raw=true "Clean Architecture Packages")

#### businessrule
- **usecase** - Application business rules and workflows
- **dto** - Data transfer objects for grouping related data
- **exception** - Custom business exceptions
- **gateway** - Interfaces for external system communication (repositories, APIs)
- **message** - Message services used by validators
- **validator** - Input validation and business rule enforcement

#### domain
- Domain entities representing core business concepts
- Shared across all API versions

#### external
- **configuration** - Application-level configurations (database, cache, etc.)

#### interfaceadapter
- **v1/controller** - REST endpoints for API v1
- **v1/autogenerated** - Auto-generated classes from v1 OpenAPI specification
- **v1/mapper** - Maps between v1 DTOs and common domain entities
- **v1/gateway** - Implements gateway interfaces for v1

- **v2/controller** - REST endpoints for API v2 (with enhanced features)
- **v2/autogenerated** - Auto-generated classes from v2 OpenAPI specification
- **v2/mapper** - Maps between v2 DTOs and common domain entities
- **v2/gateway** - Implements gateway interfaces for v2

- **delegate** - Delegates auto-generated by OpenAPI Generator (used by v1 and v2)
- **repository** - Database access layer (shared)
- **util** - Utility classes (shared)

## Quick Start

### Setup Git Hooks

```bash
git config core.hooksPath .githooks
```

This ensures your commits follow the Conventional Commits specification.

### Start Dependencies (MongoDB, Redis, etc.)

```bash
docker-compose -f misc/docker/docker-compose.yml up -d
```

### Run Application

```bash
./mvnw spring-boot:run
# or via IDE
```

### Stop Dependencies

```bash
docker-compose -f misc/docker/docker-compose.yml down -v
```

## API Endpoints

The application exposes two API versions with independent specifications:

### API v1 (Legacy)
- **Base Path**: `/v1/capitalization-titles`
- **Endpoints**:
  - `GET /v1/capitalization-titles` - List capitalization titles
  - `GET /v1/capitalization-titles/{id}` - Get capitalization title details
  - `GET /v1/capitalization-titles/{planId}/plan-info` - Get plan information
  - `GET /v1/capitalization-titles/events` - List events
- **DTO Location**: `br.com.bradescoseguros.opin.v1.interfaceadapter.autogenerated.domain.*`
- **Specification**: `src/main/resources/specification/v1/capitalization-title-v1.yaml`

### API v2 (Enhanced)
- **Base Path**: `/v2/capitalization-titles`
- **Endpoints**:
  - `GET /v2/capitalization-titles` - List capitalization titles (with advanced filters)
  - `GET /v2/capitalization-titles/{id}` - Get capitalization title with detailed info
  - `GET /v2/capitalization-titles/{planId}/plan-info` - Get enhanced plan information
  - `GET /v2/capitalization-titles/events` - List events with filtering
  - `POST /v2/capitalization-titles/validate` - Validate capitalization title data
- **DTO Location**: `br.com.bradescoseguros.opin.v2.interfaceadapter.autogenerated.domain.*`
- **Specification**: `src/main/resources/specification/v2/capitalization-title-v2.yaml`

### Swagger UI & Documentation
- Swagger-ui: [http://localhost:8080/swagger-ui/#/](http://localhost:8080/swagger-ui/#/)
- API docs: [http://localhost:8080/v3/api-docs](http://localhost:8080/v3/api-docs)

## Accessing Services

### MongoDB
- **Mongo Express**: [http://localhost:8086](http://localhost:8086)
  - Username: `dev`
  - Password: `dev!`
  - Note: No need to run the application, just Docker

### Application Endpoints
- **Actuator**: [http://localhost:8080/actuator](http://localhost:8080/actuator)
- **Health**: [http://localhost:8080/actuator/health](http://localhost:8080/actuator/health)
- **Info**: [http://localhost:8080/actuator/info](http://localhost:8080/actuator/info) (Git + Build info)
- **Environment**: [http://localhost:8080/actuator/env](http://localhost:8080/actuator/env)

## Building Docker Image

```bash
# Build the image
docker build --file Dockerfile -t opin-srv-app .

# Run the container
docker run -p 8080:8080 opin-srv-app
```

## Code Quality & Analysis

### SonarQube Integration

**Start SonarQube**:
```bash
docker-compose -f misc/docker/docker-compose.yml up -d
```

**Generate SonarQube Token**:
- Navigate to [http://localhost:9000](http://localhost:9000)
- Go to Profile → My Account → Security
- Generate a new token

**Run Analysis**:
```bash
mvn --batch-mode verify sonar:sonar \
  -Dsonar.host.url=http://localhost:9000 \
  -Dsonar.login="<your-token>"
```

**With Mutation Testing**:
```bash
mvn clean --batch-mode verify \
  org.pitest:pitest-maven:mutationCoverage \
  sonar:sonar \
  -Dsonar.host.url=http://localhost:9000 \
  -Dsonar.login="<your-token>" \
  -DmutationThreshold=90
```

### PMD & CPD Analysis

```bash
# Run PMD Linter and Copy Paste Detection
./mvnw pmd:pmd pmd:cpd
```

## OpenAPI Code Generation

The project uses OpenAPI Generator to create DTOs and controllers from YAML specifications.

### Regenerating Code

Both v1 and v2 specifications are automatically processed during Maven build:

```bash
mvn clean compile
```

This generates:
- **v1**: `target/generated-sources/openapi/src/main/java/br/com/bradescoseguros/opin/v1/`
- **v2**: `target/generated-sources/openapi/src/main/java/br/com/bradescoseguros/opin/v2/`

### Modifying Specifications

- **V1 Spec**: `src/main/resources/specification/v1/capitalization-title-v1.yaml`
- **V2 Spec**: `src/main/resources/specification/v2/capitalization-title-v2.yaml`

Changes to specifications require rebuilding to regenerate the auto-generated classes.

## Docker & System Setup

### Install Docker

```bash
sudo apt-get update -y

sudo apt-get purge docker-ce docker-ce-cli containerd.io -y

curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo apt-get install docker-compose
```

### Fix Docker Permission Denied

```bash
sudo usermod -aG docker $(whoami)
sudo chmod 777 /var/run/docker.sock
docker ps
```

### Redis CLI Commands

With Redis running, access the Redis CLI:

```bash
docker exec -it <container_name> redis-cli
```

Useful Redis CLI commands:

```bash
# Monitor all calls
monitor

# List all keys
keys *

# Get a key value
GET "key"

# Check time-to-live
TTL "key"

# Clear all keys
FLUSHALL
```

## Development Workflow

### Multi-Version Development Guidelines

1. **Version Independence**: Each version (v1, v2) has its own:
   - OpenAPI specification file
   - Auto-generated DTOs and delegates
   - Controllers and gateways
   - Mappers for domain conversion

2. **Shared Components**: The following are shared across versions:
   - Domain entities (`domain/` package)
   - Business logic (`businessrule/` package)
   - Use cases and validators
   - Database repositories and entities
   - External configurations

3. **Adding New Features**:
   - For v1: Modify `src/main/resources/specification/v1/capitalization-title-v1.yaml`
   - For v2: Modify `src/main/resources/specification/v2/capitalization-title-v2.yaml`
   - Regenerate code: `mvn clean compile`
   - Update version-specific controller and gateway

4. **Testing**:
   - Each version can be tested independently
   - Shared business logic is tested once (applies to both versions)
   - Integration tests should cover both v1 and v2 endpoints

## Troubleshooting

### Build Issues

**Problem**: Classes not found in auto-generated code
```bash
# Solution: Clean and rebuild
mvn clean compile
```

**Problem**: Mapper compilation errors
```bash
# Ensure mapping configurations match the source/target DTO properties
# Check MapStruct version compatibility in pom.xml
mvn clean compile -X  # Run with debug to see details
```

### Runtime Issues

**Problem**: MongoDB connection refused
```bash
# Solution: Start Docker services
docker-compose -f misc/docker/docker-compose.yml up -d
```

**Problem**: Port already in use
```bash
# Find and kill process using port 8080
lsof -i :8080
kill -9 <PID>
```

## Build Profiles

The project supports multiple Maven profiles for different environments:

```bash
# Development build (default)
mvn clean install

# Production build (with optimizations)
mvn clean install -P production

# Skip tests
mvn clean install -DskipTests
```							  																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																											   
